Database 6
================
简介
------------
Database 6 是一个指令驱动的简易数据库，是对前一版本 Database 5 的重构和优化。

指令
------------
Database 6 通过 **指令** 来实现与用户的交互。绝大多数的指令采用如下语法：
> *指令名* *键值对1* *键值对2* ... *键值对n* *标签1* *标签2*... *标签n*

*键值对* 可以展开为如下格式：
> *键* *值*

键值对作为一个整体，可以与其他键值对或标签交换顺序，只要键值对内部的顺序不变，指令就依然合法且含义不变。例如：
```
add-field name "Hello World" constr "value>0" unique
```
指令中的`add-field`是指令名，`name "Hello World"`和`constr "value>0"`是键值对，`unique`是标签。根据上面的规则，这条指令与如下指令相等价。
```
add-field unique constr "value>0" name "Hello World" 
```
简洁起见，下面的指令只列出一种可行的排列顺序。

少数指令采用另一种语法：
> *指令名* *参数1* *参数2* ... *参数n*

例如:
```
add-record 0 1 "Hi"
```

指令名和键统称 **关键字** ，关键字不需要引号包裹。对于非关键字，则分为两种情况：
- 数字型非关键字可以不用引号，例如：`1`、`3.14`、`-41`。
- 字符串型非关键字必须使用引号，例如：`"Hello world"`、`"你好"`。
  如果字符串中出现引号，则用`\"`表示。例如：`"value(\"year\")==2020"`

包含词法或语法错误的指令不能执行，且会引发警告，提示错误原因。

表达式
----------
**表达式**是按一定格式书写以便程序求值的字符串。Database 6 表达式的格式类似于 C 或 C++ 中的表达式，靠**操作符**和**函数**来表达运算。

操作符
----------

操作符分为单目操作符和双目操作符。单目运算符写在操作数左边，例如`-3`、`!0`。双目操作符写在左右操作数之间，例如`2*5`。每个操作符都具有**优先级**，优先级小的操作优先计算。

下面列出了全部的操作符。

操作符|操作|操作数要求|优先级
:-: | :-: | :-: | :-: 
!|取反|数字|2
*|求积|数字|3
/|求商|数字|3
%|取模|数字|3
+|求和或拼接字符串|任意|4
-|求差|数字|4
>=|判断是否大于或等于|数字|6
<=|判断是否小于或等于|数字|6
=或==|判断数字或字符串是否相等|任意|7
!=|判断数字或字符串是否不相等|任意|7
&&|且|数字|11
\|\||或|数字|12
,|连接参数|任意|15

操作数要求标记为“数字”的操作符会在计算前检查操作数是否能被转化为数字，如果不行，就返回空值`null`。

函数
----------
函数以*函数名*打头，后跟以一对圆括号`()`包裹的参数列表。参数之间用`,`隔开。格式如下：
> *函数名*(*参数1*,*参数2*,...,*参数n*)

以下是一般语境下支持的函数：
函数|功能|参数
:-: | :-: | :-: 
`floor(n)`|去除`n`的所有小数位|`n`是数字
`round(n)`|对`n`四舍五入至整数|`n`是数字
`match(s,r)`|返回字符串`s`是否能被正则表达式`r`匹配一次或以上|`s`和`r`是字符串

请注意，在特定语境下可能会提供**语境关联**的函数来完成特定的任务,具体信息参见下文。

变量
----------
变量在一次计算中有确定的值，可以用来充当操作数或函数的参数。你无法在表达式中定义变量，但可以使用预定义的变量。

以下是预定义的变量：
变量|值
:-: | :-: 
pi|3.1416

请注意，在特定语境下可能会提供**语境关联**的变量来完成特定的任务,具体信息参见下文。

字段
----------
**字段**是数据库的列，每一个字段都具有五个属性：**字段名**、**约束**、**格式**、**唯一性** 和 **提示信息**。

字段名是字段的唯一标识符，不可为空，不可与其他字段重复。
 
约束是字段中的数据必须满足的表达式。不满足此表达式的数据无法被输入数据库中；字段的约束也无法设置为其中已有数据不满足的表达式。约束为空的字段可以接受任何数据。

格式是数据显示时计算的表达式，计算的结果会替代数据原值被显示。格式为空时，数据原值会被显示。

约束和格式表达式都可以通过`value`变量来取得记录的值。

唯一性是一个布尔值（真或假,在指令中用`0`或`1`表示），唯一性为真的字段不接受重复的数据。字段中存在重复数据时也不能将字段唯一性修改为真。

提示信息是对字段的注释，方便录入人员理解字段的含义和要求。

添加字段
------------
用`add-field`指令添加字段：
> add-field <name *字段名*> [constr *约束*] [format *格式*] [info *提示信息*] [unique]

（尖括号`<>`中的项目必选，方括号`[]`中可选，*斜体*为占位符，后同）

可选的项目如果省略，表示对应的字段属性为空（或假），例如：
```
add-field name "得分" constr "value>=0&&value<=100" format "value+\"分\""
```
这条指令将创建一个名为“得分”的字段。该字段限制数据必须是一个在0-100之间的数。显示时，字段格式会在末尾加上“分”字。没有`unique`标签，说明字段中可以包含重复数据。

列出字段
------------
用`list-field`指令列出全部字段信息：
> list-field

更新字段
------------
用`update-field`指令更新字段的属性：
> update-field <name *字段名*> [set-name *新字段名*] [set-constr *新约束* | disable-constr] [set-format *新格式* | disable-format] [set-info *新提示信息* | disable-info] [set-unique *新唯一性* | disable-unique]

（`|`表示二选一）

方括号`[]`中的`set-X Y`键值对表示将字段的X属性修改为Y，而与之相对的`disable-X`标签表示将字段的X属性设置为空（或假）。对于每个不同的属性X，`set-X Y`和`disable-X`只能出现其一。特别地，`set-unique 0`和`disable-unique`是等价的。

例如：
```
update-field name "ID" set-name "学号" set-constr "match(value,\"[0-9]{8}\")" disable-format set-unique 1
```
这条指令将字段“ID”重命名为“学号”、约束设置为满足正则表达式`[0-9]{8}`（8位数字）的字符串、将格式设置为空（禁用格式）并且将唯一性设置为真。

删除字段
------------

用`remove-field`指令来删除字段：
> remove-field name *字段名*

记录
------------
**记录**是数据库的行。记录中的每个单元格都对应一列，即一个字段。

添加记录
------------
用`add-record`指令来添加一条记录：
> add-record *值1* *值2* ... *值n*

每个值对应一个字段。如果n小于字段数，缺少的值会记作`null`，如果n大于字段数，多出的值会被忽略。

修改记录
------------
用`update-record`指令来修改一条记录的某个字段：
> update-record filter *筛选条件* field *字段名* value *新值*

筛出第一个满足筛选条件条件的记录的指定字段将被赋予新值。在筛选条件表达式中，用value函数来取值：
> value(*字段名*)


例如：
```
update-record filter "value(\"ID\")==10" field "ID" value 11 
```

会将“ID”字段为10的记录的“ID”字段改为11。

删除记录
------------
用`remove-record`指令来删除一条或多条记录：
> remove-record filter *筛选条件*

所有满足条件的记录会被删除。在筛选条件表达式中，用value函数来取值：
> value(*字段名*)

例如：
```
remove-record filter "value(\"姓名\")==\"张三\""
```
会将“姓名”字段为“张三”的记录删除。

查找记录
------------
用`list-record`指令来查找记录：
> list-record [filter *筛选条件*] [sort *排序交换条件*] [raw]

所有满足条件的记录会被列出。在筛选条件表达式中，用value函数来取值：
> value(*字段名*)

例如：
```
list-record filter "value(\"班级\")==\"1901\""
```
会列出所有“班级”字段为“1901”的记录。

如果指定指定排序交换条件，则会对输出的记录进行排序。在排序过程中，会发生多次“顺序错误”记录间的两两互换。通过对所有“顺序错误”的记录进行互换，使得全局顺序“正确”。排序交换条件是在这一过程中决定是否交换记录a和记录b的表达式：如果它对记录a和记录b取正值，则交换记录a和记录b，否则不交换。

在排序交换条件中，用valuea函数和valueb函数分别来取记录a和记录b的某字段值：
> valuea(*字段名*)    
> valueb(*字段名*)

例如，要将“班级”字段为“1901”的记录列出并按“ID”字段升序排序，可以使用以下命令。
```
list-record filter "value(\"班级\")==\"1901\"" sort "valuea(\"ID\")-valueb(\"ID\")"
```
文件相关
------------
你可以从硬盘中读取数据库文件，也可以将当前数据库写入硬盘。

载入文件
-----------
用`load`指令载入文件:
> load file *路径*

文件路径可以是相对路径或绝对路径。

读取文件
-----------
用`save`指令读取文件：
> save file *路径*

文件路径可以是相对路径或绝对路径。
